<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="author" content="Andreas Rodriguez Rivera">
    <meta name="description" content="Mal doch einfach drauflos.">
    <meta name="keywords" content="vanilla JS only, game, drawing">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mal mal!</title>
    <link rel="shortcut icon" href="/images/icons/arrit_icon2.32x32.png">
    <link rel="icon" type="image/png" href="/images/icons/arrit_icon2.32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/icons/arrit_icon2.96x96.png" sizes="96x96">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/arrit_icon2.180x180.png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet" />
    <link href="/css/style.css" rel="stylesheet" />
    <link href="/css/game-styles.css" rel="stylesheet" />
    <script src="/games/malmal/malmal.js" defer></script>
    <style type="text/css">

        svg.paintboard {
            background-color: #333;
            position: relative;
            width: 100%;
            height: 80vh;
        }

        header > h1 {
            margin: 0;
            padding: 0.25rem;
        }
        .toolbar {
            display: flex;
            gap: 0.25rem;
            background-color: #555;
            margin-bottom: 0.25rem;
            padding: 0.25rem;
        }

        .toolbar button {
            font-size: 1.25rem;
            background-color: #333;
            color: white;
            border-style: solid;
            border-color: silver;
            border-radius: 15%;
        }

        .toolbar button:is(:focus,:hover) {
            background-color: grey;
        }

        .submenuparent {
            position: relative;
        }

        .submenu {
            position: absolute;
            z-index: 1;
            display: none;
        }

        .submenu[data-show] {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding-top: 0.25rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>Mal mal!
        </h1>
        <div class="toolbar">
            <button id="resetAll" title="reset">&larrb;</button>
            <div id="colorpickmenu" class="submenuparent">
                <button id="colorpick" title="Colorpicker">&ofcir;</button>
                <div id="colorpickmenulist" class="submenu">
                    <button class="colorpick" title="Yellow" data-color="yellow" style="color: yellow;">&ofcir;</button>
                    <button class="colorpick" title="Red" data-color="red" style="color: red;">&ofcir;</button>
                    <button class="colorpick" title="Blue" data-color="blue" style="color: blue;">&ofcir;</button>
                    <button class="colorpick" title="Fuchsia" data-color="fuchsia" style="color: fuchsia;">&ofcir;</button>
                    <button class="colorpick" title="Turquoise" data-color="turquoise" style="color: turquoise;">&ofcir;</button>
                    <button class="colorpick" title="Lawngreen" data-color="lawngreen" style="color: lawngreen;">&ofcir;</button>
                </div>
            </div>
            <div class="submenuparent">
                <button id="strokewidthpick" title="Strokewidthpicker">&marker;</button>
                <div id="strokewidthsubmenu" class="submenu">
                    <input type="range" min="1" max="10" value="1" />
                </div>
            </div>
        </div>
    </header>
    <main>
        <svg class="paintboard" xmlns="http://www.w3.org/2000/svg"></svg>
    </main>
    <script>
/*<![CDATA[*/
const svgNamespaceURI = 'http://www.w3.org/2000/svg';
const board = document.querySelector('svg');
const allDrawings = [];
const ongoingDrawings = [];
const startColor = 'yellow';
let currentColor = startColor;
const startStrokeWidth = '1';
let currentStrokeWidth = startStrokeWidth;

const colorpickmenulist = document.querySelector('#colorpickmenulist');
const colorpickButton = document.querySelector('#colorpick');
colorpick.style.color = currentColor;

const strokewidthsubmenu = document.querySelector('#strokewidthsubmenu');

function toggleSubmenu(submenuNode) {
    let isActive = submenuNode.matches('[data-show]');

    if(isActive){
        submenuNode.removeAttribute('data-show');
    } else {
        submenuNode.setAttribute('data-show','');
    }
}

colorpickButton.addEventListener('click', event => {
    toggleSubmenu(colorpickmenulist);
});

document.querySelector('#strokewidthpick').addEventListener('click',event => {
    toggleSubmenu(strokewidthsubmenu);
});

strokewidthsubmenu.querySelector('input[type="range"]').addEventListener('change', event => {
    currentStrokeWidth = event.target.value;
});

colorpickmenulist.addEventListener('click', event => {
    if(!event.target.matches('button.colorpick')) return;
    currentColor = event.target.dataset.color;
    colorpick.style.color = currentColor;
    colorpickButton.dispatchEvent(new Event('click'));
});

function handleTouchStart(event) {
	event.preventDefault();
	Array.from(event.touches).forEach(touch => {
        let polyline = document.createElementNS(svgNamespaceURI,'polyline');
        board.appendChild(polyline);
        polyline.setAttribute('fill','none');
        polyline.setAttribute('stroke', currentColor);
        let points = (touch.pageX - board.parentNode.offsetLeft) + ',' + (touch.pageY - board.parentNode.offsetTop);
        polyline.setAttribute('points',points);
        polyline.setAttribute('stroke-width', currentStrokeWidth);
        let drawing = {
            identifier: touch.identifier,
            touchPoints: [touch],
            polyline: polyline
        };
		ongoingDrawings.push(drawing);
        allDrawings.push(drawing);
        console.log('touchStart', drawing, event);
	});
}

function findOngoingDrawingByID(touchID) {
	return ongoingDrawings.find(drawing => drawing.identifier === touchID);
}

function handleTouchMove(event){
    event.preventDefault();
    Array.from(event.changedTouches)
        .forEach(touch => {
            let ongoingDrawing = findOngoingDrawingByID(touch.identifier);

            if(ongoingDrawing === undefined) return;

            ongoingDrawing.touchPoints.push(touch);
            let newPoints = (touch.pageX - board.parentNode.offsetLeft) + ',' + (touch.pageY - board.parentNode.offsetTop);;
            ongoingDrawing.polyline.attributes.points.textContent += ' ' + newPoints;
        });
}

function handleTouchEnd(event) {
	event.preventDefault();
	let endedTouches = Array.from(event.changedTouches).filter(touch => findOngoingDrawingByID(touch.identifier) !== undefined);
	let movementVectors = endedTouches.map(touch => {
		let drawing = findOngoingDrawingByID(touch.identifier);
        drawing.touchPoints.push(touch);
        let newPoints = (touch.pageX - board.parentNode.offsetLeft) + ',' + (touch.pageY - board.parentNode.offsetTop);;
        drawing.polyline.attributes.points.textContent += ' ' + newPoints;
        ongoingDrawings.splice(ongoingDrawings.indexOf(drawing), 1);
        console.log('touchEnd', drawing, event);
		return drawing;
	});
    //console.log(movementVectors);
}

board.addEventListener('touchstart', handleTouchStart, false);
board.addEventListener('touchmove', handleTouchMove, false);
board.addEventListener('touchend', handleTouchEnd, false);
/*]]>*/
    </script>
</body>
</html>