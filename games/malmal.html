<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="author" content="Andreas Rodriguez Rivera">
    <meta name="description" content="Mal doch einfach drauflos.">
    <meta name="keywords" content="vanilla JS only, game, drawing">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mal mal!</title>
    <link rel="shortcut icon" href="/images/icons/arrit_icon2.32x32.png">
    <link rel="icon" type="image/png" href="/images/icons/arrit_icon2.32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/icons/arrit_icon2.96x96.png" sizes="96x96">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/arrit_icon2.180x180.png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet" />
    <link href="/css/style.css" rel="stylesheet" />
    <link href="/css/game-styles.css" rel="stylesheet" />
    <script src="/games/malmal/malmal.js" defer></script>
    <style type="text/css">
        
        svg.paintboard {
            background-color: #333;
            position: relative;
            width: 100%;
            height: 80vh;
        }

        header > h1 {
            margin: 0;
            padding: 0.25rem;
        }
        .toolbar {
            display: flex;
            gap: 0.25rem;
        }
        .toolbar button {
            font-size: 1.25rem;
        }

        #colorpick {
            background-color: #333;
        }
    </style>
</head>
<body>
    <header>
        <h1>Mal mal!
        </h1>
        <div class="toolbar">
            <button id="resetAll" title="reset">&larrb;</button>
            <button id="colorpick" title="colorpick">&ofcir;</button>
        </div>
    </header>
    <main>
        <svg class="paintboard" xmlns="http://www.w3.org/2000/svg"></svg>
    </main>
    <script>
/*<![CDATA[*/
const svgNamespaceURI = 'http://www.w3.org/2000/svg';
const board = document.querySelector('svg');
const allDrawings = [];
const ongoingDrawings = [];
const startColor = 'yellow';
let currentColor = startColor;
const startStrokeWidth = '1';
let currentStrokeWidth = startStrokeWidth;

const colorpickButton = document.querySelector('#colorpick');
colorpick.style.color = currentColor;

function handleTouchStart(event) {
	event.preventDefault();
	Array.from(event.touches).forEach(touch => {
        let polyline = document.createElementNS(svgNamespaceURI,'polyline');
        board.appendChild(polyline);
        polyline.setAttribute('fill','none');
        polyline.setAttribute('stroke', currentColor);
        let points = (touch.pageX - board.parentNode.offsetLeft) + ',' + (touch.pageY - board.parentNode.offsetTop);
        polyline.setAttribute('points',points);
        polyline.setAttribute('stroke-width', currentStrokeWidth);
        let drawing = {
            identifier: touch.identifier,
            touchPoints: [touch],
            polyline: polyline
        };
		ongoingDrawings.push(drawing);
        allDrawings.push(drawing);
        console.log('touchStart', drawing, event);
	});
}

function findOngoingDrawingByID(touchID) {
	return ongoingDrawings.find(drawing => drawing.identifier === touchID);
}

function handleTouchMove(event){
    event.preventDefault();
    Array.from(event.changedTouches)
        .forEach(touch => {
            let ongoingDrawing = findOngoingDrawingByID(touch.identifier);

            if(ongoingDrawing === undefined) return;

            ongoingDrawing.touchPoints.push(touch);
            let newPoints = (touch.pageX - board.parentNode.offsetLeft) + ',' + (touch.pageY - board.parentNode.offsetTop);;
            ongoingDrawing.polyline.attributes.points.textContent += ' ' + newPoints;
        });
}

function handleTouchEnd(event) {
	event.preventDefault();
	let endedTouches = Array.from(event.changedTouches).filter(touch => findOngoingDrawingByID(touch.identifier) !== undefined);
	let movementVectors = endedTouches.map(touch => {
		let drawing = findOngoingDrawingByID(touch.identifier);
        drawing.touchPoints.push(touch);
        let newPoints = (touch.pageX - board.parentNode.offsetLeft) + ',' + (touch.pageY - board.parentNode.offsetTop);;
        drawing.polyline.attributes.points.textContent += ' ' + newPoints;
        ongoingDrawings.splice(ongoingDrawings.indexOf(drawing), 1);
        console.log('touchEnd', drawing, event);
		return drawing;
	});
    //console.log(movementVectors);
}

board.addEventListener('touchstart', handleTouchStart, false);
board.addEventListener('touchmove', handleTouchMove, false);
board.addEventListener('touchend', handleTouchEnd, false);
/*]]>*/
    </script>
</body>
</html>